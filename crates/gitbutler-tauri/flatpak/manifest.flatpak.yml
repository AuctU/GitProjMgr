id: com.gitbutler.app

runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk

command: launch.sh
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=network
  - --filesystem=/tmp
  - --filesystem=/sys
  - --filesystem=/var
  - --filesystem=host
  - --allow=devel
  - --socket=ssh-auth
  - --socket=gpg-agent
  - --socket=system-bus
  - --socket=session-bus
  - --env=PATH=/app/bin:/usr/bin:/run/host/bin
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  - --filesystem=xdg-run/gnupg:ro
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.kde.kwalletd6
  - --talk-name=org.kde.kwalletd5
  - --talk-name=org.gnome.keyring.SystemPrompter

separate-locales: false
modules:
  - name: binary
    buildsystem: simple
    build-options:
      no-debuginfo: true
    sources:
      - type: file
        path: com.gitbutler.app.metainfo.xml
      - type: file
        dest-filename: gitbutler.deb
        url: file:///opt/gitbutler/gitbutler/target/debug/bundle/deb/GitButler Nightly_0.0.0_amd64.deb
        sha256: 94db605fc2b6358c71cc5b94d169093e87fe57488c7855ff92b43977ca776bb1
      # - type: file
      #   dest-filename: gitbutler.deb
      #   url: https://releases.gitbutler.com/releases/release/0.13.11-1445/linux/x86_64/GitButler_0.13.11_amd64.deb
      #   sha256: 6495589f30c0b5b7d894e268fae6bd569d4e01cbf33de22df262b07cab0507f3
      #   only-arches:
      #     - x86_64
      #   x-checker-data:
      #     type: json
      #     url: https://app.gitbutler.com/releases
      #     version-query: .version
      #     timestamp-query: .pub_date
      #     url-query: .platforms."linux-x86_64".url | sub(".AppImage.tar.gz"; ".deb")
      - type: script
        commands:
          - "/app/bin/gitbutler-tauri"
        dest-filename: "launch.sh"
    build-commands:
      - ar -x *.deb
      - tar -xf data.tar.gz
      - install -Dm755 launch.sh /app/bin/launch.sh
      - install -Dm755 usr/bin/gitbutler-tauri /app/bin/gitbutler-tauri
      - install -Dm755 usr/bin/gitbutler-git-askpass /app/bin/gitbutler-git-askpass
      - install -Dm755 usr/bin/gitbutler-git-setsid /app/bin/gitbutler-git-setsid
      # - install -Dm644 usr/share/applications/GitButler.desktop /app/share/applications/com.gitbutler.app.desktop
      - install -Dm644 usr/share/applications/GitButler\ Nightly.desktop /app/share/applications/com.gitbutler.app.desktop
      - desktop-file-edit --set-icon=com.gitbutler.app /app/share/applications/com.gitbutler.app.desktop
      - |
        for size in 32x32 128x128 256x256@2; do
          install -Dm644 usr/share/icons/hicolor/${size}/apps/gitbutler-tauri.png /app/share/icons/hicolor/${size}/apps/com.gitbutler.app.png
        done
      - install -Dm644 com.gitbutler.app.metainfo.xml /app/share/metainfo/com.gitbutler.app.metainfo.xml
      - rm -r *.deb control.tar.* data.tar.gz debian-binary usr
